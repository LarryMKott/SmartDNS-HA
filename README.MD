# DNSHA

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Shell Script](https://img.shields.io/badge/Shell-Script-89e051.svg)](https://www.gnu.org/software/bash/)
[![Debian](https://img.shields.io/badge/OS-Debian%2013+-blue.svg)](https://www.debian.org/)

DNSHA æ˜¯ä¸€æ¬¾**çº¯Shellå®ç°**çš„DNSä¸»å¤‡å®¹ç¾ä¸€é”®éƒ¨ç½²ç³»ç»Ÿï¼ŒåŸºäº SmartDNS + AdGuard Home æ„å»ºé«˜å¯ç”¨DNSæœåŠ¡ï¼Œæ”¯æŒ VRRP/Haproxy/Consul ä¸‰ç§å®¹ç¾æ¨¡å¼ï¼Œå…·å¤‡ç§’çº§VIPæ¼‚ç§»ã€å®æ—¶é…ç½®åŒæ­¥ã€å…¨é“¾è·¯å¥åº·ç›‘æ§èƒ½åŠ›ï¼Œæ ¸å¿ƒä¼˜åŠ¿æ˜¯**è½»é‡çº§ã€é›¶é…ç½®å¤æ‚åº¦ã€çº¯åŸç”ŸShellå®ç°**ï¼Œæ— Python/Windowsä¾èµ–ï¼Œé€‚é…DebianæœåŠ¡å™¨è‡ªåŠ¨åŒ–è¿ç»´åœºæ™¯ã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§
- **çº¯Shellå®ç°**ï¼šä»…ä¾èµ–LinuxåŸç”Ÿå·¥å…·ï¼ˆbash/ssh/rsyncç­‰ï¼‰ï¼Œæ— ä»»ä½•å¤–éƒ¨è¯­è¨€ä¾èµ–ï¼Œéƒ¨ç½²åŒ…<100KBï¼›
- **ä¸€é”®éƒ¨ç½²**ï¼šå•è„šæœ¬å®Œæˆä¸»å¤‡èŠ‚ç‚¹çš„DNSæœåŠ¡å®‰è£…ã€å®¹ç¾é…ç½®ã€VIPç»‘å®šã€é…ç½®åŒæ­¥å…¨æµç¨‹ï¼›
- **å¤šå®¹ç¾æ¨¡å¼**ï¼šæ”¯æŒ VRRPï¼ˆé»˜è®¤ï¼Œç§’çº§VIPæ¼‚ç§»ï¼‰ã€Haproxyï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ã€Consulï¼ˆæœåŠ¡å‘ç°ï¼‰ä¸‰ç§æ¨¡å¼ï¼›
- **å®æ—¶é…ç½®åŒæ­¥**ï¼šåŸºäº inotify + rsync å®ç°ä¸»å¤‡èŠ‚ç‚¹é…ç½®å®æ—¶åŒæ­¥ï¼Œå»¶è¿Ÿ<1ç§’ï¼›
- **å…¨é“¾è·¯ç›‘æ§**ï¼šå†…ç½®å¥åº·æ£€æŸ¥è„šæœ¬ï¼Œå®æ—¶ç›‘æ§æœåŠ¡çŠ¶æ€ã€VIPç»‘å®šã€DNSè§£æã€åŒæ­¥æœåŠ¡ï¼›
- **æ•…éšœè‡ªæ„ˆ**ï¼šæä¾›ä¸€é”®ä¿®å¤/é…ç½®å›æ»šå·¥å…·ï¼Œæ”¯æŒDNSæœåŠ¡ã€å®¹ç¾æœåŠ¡ã€åŒæ­¥æœåŠ¡å¿«é€Ÿæ¢å¤ï¼›
- **é«˜æ€§èƒ½**ï¼šå•èŠ‚ç‚¹æ”¯æŒ10000 QPSï¼ŒVIPåˆ‡æ¢å»¶è¿Ÿ<3ç§’ï¼Œç¬¦åˆç”Ÿäº§çº§æ€§èƒ½è¦æ±‚ã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶
### ç¯å¢ƒè¦æ±‚
| èŠ‚ç‚¹ç±»å‹       | ç³»ç»Ÿç‰ˆæœ¬       | ç¡¬ä»¶è¦æ±‚       | æƒé™è¦æ±‚ |
|----------------|----------------|----------------|----------|
| ä¸»/å¤‡èŠ‚ç‚¹      | Debian 13+     | CPU â‰¥1æ ¸ï¼Œå†…å­˜ â‰¥512MB | root     |
| éƒ¨ç½²èŠ‚ç‚¹       | ä»»æ„Linuxç³»ç»Ÿ  | æ— ç‰¹æ®Šè¦æ±‚     | root     |

### ç½‘ç»œè¦æ±‚
- ä¸»/å¤‡/éƒ¨ç½²èŠ‚ç‚¹ç½‘ç»œäº’é€šï¼Œå¼€æ”¾ä»¥ä¸‹ç«¯å£ï¼š
  - 22ï¼ˆSSHï¼‰ï¼šç”¨äºè„šæœ¬éƒ¨ç½²å’Œè¿œç¨‹æ‰§è¡Œï¼›
  - 53ï¼ˆTCP/UDPï¼‰ï¼šDNSè§£ææœåŠ¡ï¼›
  - 8080ï¼ˆTCPï¼‰ï¼šAdGuard Home Webç®¡ç†ï¼›
  - 11211ï¼ˆTCP/UDPï¼Œå¯é€‰ï¼‰ï¼šConsulæ¨¡å¼æœåŠ¡å‘ç°ï¼›
- ä¸»å¤‡èŠ‚ç‚¹æ”¯æŒSSHç™»å½•ï¼ˆä¼˜å…ˆå…å¯†ï¼Œä¹Ÿå¯ä½¿ç”¨å¯†ç ï¼‰ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹
### 1. ä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰

#### å›½å†…ç”¨æˆ·ï¼ˆæ¨èä½¿ç”¨å›½å†…åŠ é€Ÿï¼‰
```bash
# å›½å†…åŠ é€Ÿå®‰è£…ï¼ˆä½¿ç”¨ghproxy.comåŠ é€ŸGitHubè®¿é—®ï¼‰
curl -fsSL https://ghproxy.com/https://raw.githubusercontent.com/LarryMKott/SmartDNS-HA/master/install.sh | bash -s -- --cn

# å›½å†…åŠ é€Ÿ+å›ºå®šIPv4é…ç½®
curl -fsSL https://ghproxy.com/https://raw.githubusercontent.com/LarryMKott/SmartDNS-HA/master/install.sh | bash -s -- --cn \
  --ipv4 192.168.1.100/24 --gateway 192.168.1.1

# å›½å†…åŠ é€Ÿ+IPv4+IPv6é…ç½®
curl -fsSL https://ghproxy.com/https://raw.githubusercontent.com/LarryMKott/SmartDNS-HA/master/install.sh | bash -s -- --cn \
  --ipv4 192.168.1.100/24 --gateway 192.168.1.1 \
  --ipv6 2001:db8::1/64 --ipv6-gateway 2001:db8::fffe
```

#### å›½é™…ç”¨æˆ·
```bash
# ç›´æ¥ä½¿ç”¨curlå®‰è£…ï¼ˆæ”¯æŒè‡ªåŠ¨æ£€æµ‹å½“åœ°è¿è¥å•†DNSï¼‰
curl -fsSL https://raw.githubusercontent.com/LarryMKott/SmartDNS-HA/master/install.sh | bash

# è®¾ç½®å›ºå®šIPv4åœ°å€
curl -fsSL https://raw.githubusercontent.com/LarryMKott/SmartDNS-HA/master/install.sh | bash -s -- \
  --ipv4 192.168.1.100/24 --gateway 192.168.1.1

# è®¾ç½®IPv4+IPv6åœ°å€
curl -fsSL https://raw.githubusercontent.com/LarryMKott/SmartDNS-HA/master/install.sh | bash -s -- \
  --ipv4 192.168.1.100/24 --gateway 192.168.1.1 \
  --ipv6 2001:db8::1/64 --ipv6-gateway 2001:db8::fffe

# æŒ‡å®šç½‘å¡å¹¶è®¾ç½®IP
curl -fsSL https://raw.githubusercontent.com/LarryMKott/SmartDNS-HA/master/install.sh | bash -s -- \
  --interface eth1 \
  --ipv4 192.168.1.100/24 --gateway 192.168.1.1
```

### 2. æ‰‹åŠ¨ä¸‹è½½è„šæœ¬åŒ…
```bash
# åˆ›å»ºè„šæœ¬ç›®å½•å¹¶è¿›å…¥
mkdir -p /opt/dnsha && cd /opt/dnsha

# ä¸‹è½½æ‰€æœ‰æ ¸å¿ƒè„šæœ¬
git clone https://github.com/LarryMKott/SmartDNS-HA.git .

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x *.sh
```

### 2. ä¸€é”®éƒ¨ç½²
#### æ–¹å¼1ï¼šå‘½ä»¤è¡Œå‚æ•°éƒ¨ç½²ï¼ˆæ¨èï¼‰
```bash
# VRRPæ¨¡å¼ï¼ˆé»˜è®¤ï¼Œç§’çº§VIPæ¼‚ç§»ï¼‰
./deploy_dns.sh \
  --master-ip 192.168.1.100 \  # ä¸»èŠ‚ç‚¹IPï¼ˆå¿…å¡«ï¼‰
  --slave-ip 192.168.1.101 \   # å¤‡èŠ‚ç‚¹IPï¼ˆå¿…å¡«ï¼‰
  --master-pwd your-root-pwd \ # ä¸»èŠ‚ç‚¹rootå¯†ç ï¼ˆå…å¯†å¯çœç•¥ï¼‰
  --slave-pwd your-root-pwd \  # å¤‡èŠ‚ç‚¹rootå¯†ç ï¼ˆå…å¯†å¯çœç•¥ï¼‰
  --vip 192.168.1.200/24 \     # è™šæ‹ŸIPï¼ˆé»˜è®¤192.168.1.200/24ï¼‰
  --interface eth0             # ç½‘å¡åç§°ï¼ˆé»˜è®¤eth0ï¼‰

# Haproxyæ¨¡å¼ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
./deploy_dns.sh \
  --master-ip 192.168.1.100 \
  --slave-ip 192.168.1.101 \
  --failover-mode haproxy

# Consulæ¨¡å¼ï¼ˆæœåŠ¡å‘ç°ï¼‰
./deploy_dns.sh \
  --master-ip 192.168.1.100 \
  --slave-ip 192.168.1.101 \
  --failover-mode consul
```

#### æ–¹å¼2ï¼šé…ç½®æ–‡ä»¶éƒ¨ç½²
```bash
# 1. åˆ›å»ºé…ç½®æ–‡ä»¶
cat > dnsha.conf << EOF
master_ip = 192.168.1.100
slave_ip = 192.168.1.101
master_password = your-root-pwd
slave_password = your-root-pwd
failover_mode = vrrp
vip = 192.168.1.200/24
interface = eth0
sync_interval = 1
EOF

# 2. æ‰§è¡Œéƒ¨ç½²
./deploy_dns.sh --config dnsha.conf
```

### 3. éªŒè¯éƒ¨ç½²
```bash
# ä¸€é”®éªŒè¯éƒ¨ç½²ç»“æœï¼ˆä»…æ£€æŸ¥ä¸€æ¬¡ï¼‰
./health_check.sh \
  --master-ip 192.168.1.100 \
  --slave-ip 192.168.1.101 \
  --vip 192.168.1.200 \
  --once
```

## ğŸ“– è¯¦ç»†ä½¿ç”¨æŒ‡å—
### æ ¸å¿ƒè„šæœ¬è¯´æ˜
| è„šæœ¬åç§°          | åŠŸèƒ½æè¿°                                  | æ ¸å¿ƒå‚æ•°                                                                 |
|-------------------|-------------------------------------------|--------------------------------------------------------------------------|
| `deploy_dns.sh`   | ä¸€é”®éƒ¨ç½²ä¸»å¤‡èŠ‚ç‚¹ï¼ˆæ ¸å¿ƒå…¥å£ï¼‰              | `--master-ip`/`--slave-ip`/`--failover-mode`/`--config`                  |
| `health_check.sh` | å®æ—¶ç›‘æ§èŠ‚ç‚¹çŠ¶æ€                          | `--master-ip`/`--slave-ip`/`--interval`/`--once`                         |
| `repair_dns.sh`   | æ•…éšœä¿®å¤/é…ç½®å›æ»š                         | `--master-ip`/`--slave-ip`/`--dns`/`--failover`/`--rollback`             |
| `verify_deploy.sh`| éªŒè¯å•ä¸ªèŠ‚ç‚¹éƒ¨ç½²ç»“æœ                      | `--vip`/`--role`ï¼ˆmaster/slaveï¼‰                                         |

### å®æ—¶ç›‘æ§
```bash
# å¾ªç¯ç›‘æ§ï¼ˆæ¯5ç§’åˆ·æ–°ï¼ŒæŒ‰Ctrl+Cé€€å‡ºï¼‰
./health_check.sh -m 192.168.1.100 -s 192.168.1.101 -i 5

# ä»…æ£€æŸ¥ä¸€æ¬¡
./health_check.sh -m 192.168.1.100 -s 192.168.1.101 -o
```

### æ•…éšœä¿®å¤
```bash
# å…¨é‡ä¿®å¤ï¼ˆDNS+å®¹ç¾+åŒæ­¥æœåŠ¡ï¼‰
./repair_dns.sh -m 192.168.1.100 -s 192.168.1.101

# ä»…ä¿®å¤DNSæœåŠ¡
./repair_dns.sh -m 192.168.1.100 -s 192.168.1.101 -d

# ä»…ä¿®å¤å®¹ç¾æœåŠ¡ï¼ˆKeepalived/Haproxy/Consulï¼‰
./repair_dns.sh -m 192.168.1.100 -s 192.168.1.101 -f

# é…ç½®å›æ»šåˆ°é»˜è®¤ç‰ˆæœ¬
./repair_dns.sh -m 192.168.1.100 -s 192.168.1.101 -r
```

## ğŸ§ª æµ‹è¯•è®¡åˆ’
### åŠŸèƒ½æµ‹è¯•
```bash
# 1. éªŒè¯DNSæœåŠ¡è¿è¡Œ
ssh root@192.168.1.100 "pgrep -f smartdns && pgrep -f AdGuardHome"

# 2. éªŒè¯VIPç»‘å®šï¼ˆä¸»èŠ‚ç‚¹åº”ç»‘å®šï¼‰
ssh root@192.168.1.100 "ip addr | grep 192.168.1.200"

# 3. éªŒè¯é…ç½®åŒæ­¥ï¼ˆä¿®æ”¹ä¸»èŠ‚ç‚¹é…ç½®ï¼Œå¤‡èŠ‚ç‚¹åº”åŒæ­¥ï¼‰
ssh root@192.168.1.100 "echo 'test' >> /etc/smartdns/test.conf"
sleep 2
ssh root@192.168.1.101 "cat /etc/smartdns/test.conf | grep test"

# 4. éªŒè¯å®¹ç¾åˆ‡æ¢ï¼ˆåœæ­¢ä¸»èŠ‚ç‚¹Keepalivedï¼Œå¤‡èŠ‚ç‚¹ç»‘å®šVIPï¼‰
ssh root@192.168.1.100 "systemctl stop keepalived"
sleep 3
ssh root@192.168.1.101 "ip addr | grep 192.168.1.200"

# 5. æ•…éšœæ¢å¤ï¼ˆé‡å¯ä¸»èŠ‚ç‚¹ï¼ŒVIPåˆ‡å›ï¼‰
ssh root@192.168.1.100 "systemctl start keepalived"
sleep 3
ssh root@192.168.1.100 "ip addr | grep 192.168.1.200"
```

### å‹åŠ›æµ‹è¯•
```bash
# å®‰è£…dnsperf
apt install -y dnsperf

# æ¨¡æ‹Ÿ10000 QPSæŸ¥è¯¢ï¼ŒéªŒè¯å“åº”æ—¶é—´ï¼ˆç›®æ ‡VIPï¼š192.168.1.200ï¼‰
dnsperf -d /usr/share/dnsperf/test.dns -s 192.168.1.200 -Q 10000 -l 60
```

## ğŸ› ï¸ æ—¥å¸¸è¿ç»´
### æ—¥å¿—æŸ¥çœ‹
```bash
# ä¸»èŠ‚ç‚¹é…ç½®åŒæ­¥æ—¥å¿—
ssh root@192.168.1.100 "tail -f /var/log/dns_config_sync.log"

# Keepalivedæ—¥å¿—ï¼ˆVRRPæ¨¡å¼ï¼‰
ssh root@192.168.1.100 "journalctl -u keepalived -f"

# SmartDNSæ—¥å¿—
ssh root@192.168.1.100 "tail -f /var/log/smartdns.log"
```

### æ‰‹åŠ¨åˆ‡æ¢ä¸»å¤‡
```bash
# ä¸»èŠ‚ç‚¹é™çº§ï¼ˆåœæ­¢Keepalivedï¼ŒVIPæ¼‚ç§»åˆ°å¤‡èŠ‚ç‚¹ï¼‰
ssh root@192.168.1.100 "systemctl stop keepalived"

# å¤‡èŠ‚ç‚¹å‡çº§ï¼ˆæ‰‹åŠ¨å¯åŠ¨Keepalivedï¼ŒæŠ¢å VIPï¼‰
ssh root@192.168.1.101 "systemctl restart keepalived"
```

## â“ å¸¸è§é—®é¢˜
| é—®é¢˜ç°è±¡                | æ’æŸ¥/è§£å†³æ–¹æ³•                                                                 |
|-------------------------|------------------------------------------------------------------------------|
| VIPæ— æ³•ç»‘å®š             | 1. æ£€æŸ¥ç½‘å¡åç§°æ˜¯å¦æ­£ç¡®ï¼ˆ`ip link`ï¼‰ï¼›<br>2. æŸ¥çœ‹Keepalivedæ—¥å¿—ï¼š`journalctl -u keepalived`ï¼›<br>3. ç¡®è®¤VIPç½‘æ®µä¸ç½‘å¡ä¸€è‡´ã€‚ |
| é…ç½®ä¸åŒæ­¥              | 1. æ£€æŸ¥ä¸»èŠ‚ç‚¹åŒæ­¥æœåŠ¡çŠ¶æ€ï¼š`systemctl status dns_config_sync`ï¼›<br>2. æŸ¥çœ‹åŒæ­¥æ—¥å¿—ï¼š`tail -f /var/log/dns_config_sync.log`ï¼›<br>3. ç¡®è®¤ä¸»å¤‡èŠ‚ç‚¹SSHå…å¯†äº’é€šã€‚ |
| DNSè§£æå¤±è´¥             | 1. æ£€æŸ¥SmartDNS/AdGuardè¿›ç¨‹ï¼š`pgrep -f smartdns && pgrep -f AdGuardHome`ï¼›<br>2. æŸ¥çœ‹SmartDNSæ—¥å¿—ï¼š`tail -f /var/log/smartdns.log`ï¼›<br>3. éªŒè¯ç«¯å£å ç”¨ï¼š`netstat -tulpn | grep 53`ã€‚ |
| ConsulæœåŠ¡æ— æ³•å¯åŠ¨      | 1. æ£€æŸ¥Consulé…ç½®ï¼š`cat /etc/consul.d/consul_server.json`ï¼›<br>2. æ‰‹åŠ¨å¯åŠ¨æ’æŸ¥ï¼š`consul agent -dev -client 0.0.0.0`ã€‚ |
| Haproxyè´Ÿè½½å‡è¡¡å¼‚å¸¸     | 1. æŸ¥çœ‹Haproxyæ—¥å¿—ï¼š`cat /var/log/haproxy.log`ï¼›<br>2. éªŒè¯åç«¯èŠ‚ç‚¹ï¼š`haproxy -c -f /etc/haproxy/haproxy.cfg`ã€‚ |

## ğŸš€ æ‰©å±•æ–¹å‘
1. **å¤šäº‘é€‚é…**ï¼šé›†æˆé˜¿é‡Œäº‘/è…¾è®¯äº‘SDKï¼Œè‡ªåŠ¨è·å–èŠ‚ç‚¹IPã€é…ç½®å®‰å…¨ç»„ï¼›
2. **ç›‘æ§é›†æˆ**ï¼šè¾“å‡ºPrometheusæŒ‡æ ‡ï¼Œå¯¹æ¥Grafanaå®ç°å¯è§†åŒ–ç›‘æ§ï¼›
3. **æ‰¹é‡éƒ¨ç½²**ï¼šæ”¯æŒå¤šç»„ä¸»å¤‡èŠ‚ç‚¹æ‰¹é‡éƒ¨ç½²ï¼Œé€‚é…å¤§å‹é›†ç¾¤ï¼›
4. **AIå¼‚å¸¸æ£€æµ‹**ï¼šåŸºäºShell+awkåˆ†æDNSæ—¥å¿—ï¼Œè¯†åˆ«å¼‚å¸¸æŸ¥è¯¢æµé‡ï¼›
5. **Webç®¡ç†ç•Œé¢**ï¼šå¯é€‰è½»é‡Go/Python WebæœåŠ¡ï¼Œæä¾›å¯è§†åŒ–æ“ä½œç•Œé¢ã€‚

## ğŸ“„ è®¸å¯è¯
æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯å¼€æºï¼Œè¯¦æƒ…è¯·è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ“ è´¡çŒ®ä¸åé¦ˆ
- æäº¤Issueï¼šè¯·æè¿°æ¸…æ™°é—®é¢˜ç°è±¡ã€å¤ç°æ­¥éª¤ã€ç¯å¢ƒä¿¡æ¯ï¼›
- æäº¤PRï¼šè¯·éµå¾ªShellè„šæœ¬è§„èŒƒï¼ˆç¼©è¿›2ç©ºæ ¼ã€æ³¨é‡Šæ¸…æ™°ï¼‰ï¼Œå¹¶é™„å¸¦æµ‹è¯•ç”¨ä¾‹ï¼›
- æŠ€æœ¯æ”¯æŒï¼šå¯é€šè¿‡Issuesæˆ–é‚®ä»¶ï¼ˆxxx@xxx.comï¼‰åé¦ˆé—®é¢˜ã€‚

## ğŸ“– å‚è€ƒæ–‡æ¡£
- [SmartDNS å®˜æ–¹æ–‡æ¡£](https://pymumu.github.io/smartdns/)
- [AdGuard Home å®˜æ–¹æ–‡æ¡£](https://github.com/AdguardTeam/AdGuardHome/wiki)
- [Keepalived å®˜æ–¹æ–‡æ¡£](https://keepalived.readthedocs.io/)
- [Consul å®˜æ–¹æ–‡æ¡£](https://developer.hashicorp.com/consul/docs)